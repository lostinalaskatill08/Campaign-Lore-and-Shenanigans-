<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>D&D Campaign Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for inline JSX -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />

  <style>
    /* Base Styles */
    body {
      font-family: 'Cinzel', serif;
      background: #f4e4bc url("https://www.transparenttextures.com/patterns/aged-paper.png") repeat;
      background-blend-mode: overlay;
      color: #4a2c0f;
    }
    .dark {
      background-color: #1a1a1a;
      color: #fafafa;
      background-blend-mode: normal;
    }
    /* Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 12px;
    }
    ::-webkit-scrollbar-track {
      background: #f5e8c7;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #8b5a2b;
      border-radius: 20px;
      border: 3px solid #f5e8c7;
    }
    /* Button Styles */
    .btn-dnd {
      background-color: #8B0000;
      color: #f4e4bc;
      font-family: 'Cinzel', serif;
      font-weight: bold;
      border: 1px solid #4a3f35;
      transition: all 0.3s ease;
      padding: 0.75rem 1rem;
    }
    .btn-dnd:hover {
      background-color: #6d0101;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    /* Content Panel Styles */
    .content-panel {
      background-color: #1a222e;
      border-radius: 0.5rem;
      border: 1px solid #4a3f35;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      color: #f4e4bc;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
      border-bottom: 2px solid #8B0000;
    }
    .panel-title {
      font-family: 'Cinzel', serif;
      font-weight: bold;
      font-size: 1.25rem;
      color: #f4e4bc;
    }
    /* Input Field Styles */
    .dnd-input {
      width: 100%;
      border: 1px solid #4a3f35;
      border-radius: 0.375rem;
      background-color: #f9efd4;
      color: #1a222e;
      padding: 0.75rem;
      transition: all 0.3s ease;
      font-family: 'Cormorant Garamond', serif;
    }
    .dnd-input:focus {
      outline: none;
      border-color: #6d4c3d;
      box-shadow: 0 0 5px rgba(139,90,43,0.5);
    }
    .dnd-input::placeholder {
      color: #8b5a2b;
      opacity: 0.6;
    }
    /* Item Card Styles */
    .item-card {
      background-color: #1e2a38;
      color: #f4e4bc;
      border: 1px solid #4a3f35;
      border-radius: 0.375rem;
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      font-family: 'Cormorant Garamond', serif;
      transition: all 0.3s ease;
    }
    .item-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-content {
      margin-top: 0.75rem;
      font-size: 1.1rem;
      white-space: pre-line;
    }
    .app-title {
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      font-weight: bold;
      color: #8B0000;
      text-align: center;
      margin: 1.5rem 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .card-actions {
      display: flex;
      gap: 0.5rem;
    }
    .tag {
      background-color: #442200;
      color: #f4e4bc;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      display: inline-block;
      font-size: 0.85rem;
    }
    .item-type {
      color: #f4e4bc;
      padding: 0.25rem 0.5rem;
      margin-right: 0.25rem;
      border-radius: 0.25rem;
      display: inline-block;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .type-lore {
      background-color: #2c3e50;
    }
    .type-npc {
      background-color: #8e44ad;
    }
    .type-location {
      background-color: #27ae60;
    }
    .type-event {
      background-color: #d35400;
    }
    .type-item {
      background-color: #16a085;
    }
    .type-shenanigan {
      background-color: #c0392b;
    }
    .type-note {
      background-color: #7f8c8d;
    }
    .item-title {
      font-family: 'Cinzel', serif;
      font-weight: bold;
      font-size: 1.1rem;
      margin-left: 0.5rem;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .textarea-container {
      position: relative;
    }
    .textarea-container textarea {
      width: 100%;
      height: 150px;
      border: 1px solid #4a3f35;
      border-radius: 0.375rem;
      background-color: #f9efd4;
      color: #1a222e;
      padding: 0.75rem;
      resize: vertical;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
    }
    .textarea-container textarea:focus {
      outline: none;
      border-color: #6d4c3d;
      box-shadow: 0 0 5px rgba(139,90,43,0.5);
    }
    .textarea-container textarea::placeholder {
      color: #8b5a2b;
      opacity: 0.6;
    }
    .textarea-controls {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
    }
    .char-count {
      font-size: 0.75rem;
      color: #6d4c3d;
    }
    .image-container {
      max-width: 300px;
      max-height: 300px;
      overflow: hidden;
      border-radius: 0.25rem;
      margin-top: 0.75rem;
    }
    .image-container img {
      width: 100%;
      height: auto;
      object-fit: cover;
    }
    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .filter-btn {
      background-color: #1e2a38;
      color: #f4e4bc;
      border: 1px solid #4a3f35;
      border-radius: 0.25rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .filter-btn.active {
      background-color: #8B0000;
      border-color: #f4e4bc;
    }
    .filter-btn:hover {
      background-color: #2c3e50;
    }
    .select-container {
      position: relative;
      width: 100%;
    }
    .dnd-select {
      appearance: none;
      width: 100%;
      border: 1px solid #4a3f35;
      border-radius: 0.375rem;
      background-color: #f9efd4;
      color: #1a222e;
      padding: 0.75rem;
      font-family: 'Cinzel', serif;
      cursor: pointer;
    }
    .dnd-select:focus {
      outline: none;
      border-color: #6d4c3d;
      box-shadow: 0 0 5px rgba(139,90,43,0.5);
    }
    .select-arrow {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    .search-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .search-input {
      flex-grow: 1;
    }
    .timeline {
      position: relative;
      margin: 2rem 0;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 1rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #8B0000;
    }
    .timeline-item {
      position: relative;
      margin-left: 2.5rem;
      padding-bottom: 1.5rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.5rem;
      top: 0.5rem;
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      background-color: #8B0000;
    }
    .timeline-date {
      font-family: 'Cinzel', serif;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #f4e4bc;
    }
    .timeline-content {
      background-color: #1e2a38;
      border-radius: 0.375rem;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    /**********************
     * Utility Functions
     **********************/
    function backupLocalStorage() {
      const data = {
        campaignItems: localStorage.getItem("campaignItems"),
        eventTimeline: localStorage.getItem("eventTimeline"),
        mapLocations: localStorage.getItem("mapLocations"),
        npcs: localStorage.getItem("npcs"),
        magicItems: localStorage.getItem("magicItems"),
        shenanigans: localStorage.getItem("shenanigans"),
        darkMode: localStorage.getItem("darkMode")
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "campaign_journal_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreLocalStorage(files) {
      if (!files || !files.length) return;
      const file = files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          for (const key in data) {
            if (data[key] !== null && data[key] !== undefined) {
              localStorage.setItem(key, data[key]);
            }
          }
          alert("LocalStorage restored. Please refresh the page.");
        } catch (err) {
          console.error(err);
          alert("Failed to restore. Invalid JSON?");
        }
      };
      reader.readAsText(file);
    }

    function copyForPrompt() {
      const data = {
        campaignItems: JSON.parse(localStorage.getItem("campaignItems") || "[]"),
        eventTimeline: JSON.parse(localStorage.getItem("eventTimeline") || "[]"),
        mapLocations: JSON.parse(localStorage.getItem("mapLocations") || "[]"),
        npcs: JSON.parse(localStorage.getItem("npcs") || "[]"),
        magicItems: JSON.parse(localStorage.getItem("magicItems") || "[]"),
        shenanigans: JSON.parse(localStorage.getItem("shenanigans") || "[]")
      };
      
      // Generate a formatted string with headers for each category
      let promptText = "# D&D Campaign Journal\n\n";
      
      // Campaign Lore
      promptText += "## Campaign Lore\n";
      data.campaignItems.forEach(item => {
        promptText += `- ${item.title} (${item.type}): ${item.content}\n`;
      });
      
      // Event Timeline
      promptText += "\n## Event Timeline\n";
      data.eventTimeline.forEach(event => {
        promptText += `- ${event.date}: ${event.title} - ${event.description}\n`;
      });
      
      // Locations
      promptText += "\n## Locations\n";
      data.mapLocations.forEach(location => {
        promptText += `- ${location.name} (${location.type}): ${location.description}\n`;
      });
      
      // NPCs
      promptText += "\n## NPCs\n";
      data.npcs.forEach(npc => {
        promptText += `- ${npc.name} (${npc.race}/${npc.occupation}): ${npc.personality}\n`;
      });
      
      // Magic Items
      promptText += "\n## Magic Items\n";
      data.magicItems.forEach(item => {
        promptText += `- ${item.name} (${item.rarity}): ${item.description}\n`;
      });
      
      // Shenanigans
      promptText += "\n## Shenanigans\n";
      data.shenanigans.forEach(shenanigan => {
        promptText += `- ${shenanigan.title}: ${shenanigan.description}\n`;
      });
      
      navigator.clipboard.writeText(promptText)
        .then(() => alert("Campaign Journal copied to clipboard for prompt use!"))
        .catch((err) => {
          console.error("Failed to copy: ", err);
          alert("Failed to copy data to clipboard.");
        });
    }

    /**********************
     * Dark Mode Toggle Component
     **********************/
    function DarkModeToggle() {
      const [isDark, setIsDark] = React.useState(() => {
        const saved = localStorage.getItem("darkMode");
        return saved === "true";
      });

      React.useEffect(() => {
        document.body.classList.toggle("dark", isDark);
        localStorage.setItem("darkMode", isDark);
      }, [isDark]);

      return (
        <button className="btn-dnd rounded" onClick={() => setIsDark(!isDark)}>
          {isDark ? "Light Mode" : "Dark Mode"}
        </button>
      );
    }

    /**********************
     * Campaign Item Component
     **********************/
    function CampaignItem({ item, onEdit, onDelete, onTagAdd, onTagRemove }) {
      const [isExpanded, setIsExpanded] = React.useState(false);
      const [newTag, setNewTag] = React.useState("");

      const typeClasses = {
        "Lore": "type-lore",
        "NPC": "type-npc",
        "Location": "type-location",
        "Event": "type-event",
        "Item": "type-item",
        "Shenanigan": "type-shenanigan",
        "Note": "type-note"
      };

      function handleAddTag(e) {
        e.preventDefault();
        if (newTag.trim()) {
          onTagAdd(item.id, newTag.trim());
          setNewTag("");
        }
      }

      return (
        <div className="item-card">
          <div className="card-top">
            <div className="flex items-center">
              <span className={`item-type ${typeClasses[item.type] || "type-note"}`}>{item.type}</span>
              <h3 className="item-title" onClick={() => setIsExpanded(!isExpanded)}>
                {item.title}
              </h3>
            </div>
            <div className="card-actions">
              <button 
                className="bg-amber-700 text-white rounded px-2 py-1 text-sm hover:bg-amber-800"
                onClick={() => onEdit(item)}
              >
                Edit
              </button>
              <button 
                className="btn-dnd rounded px-2 py-1 text-sm"
                onClick={() => {
                  if (window.confirm(`Are you sure you want to delete "${item.title}"?`)) {
                    onDelete(item.id);
                  }
                }}
              >
                Delete
              </button>
            </div>
          </div>
          
          <div className="collapsible-content" style={{ maxHeight: isExpanded ? "1000px" : "0px" }}>
            <div className="card-content">
              {item.content}
            </div>
            
            {item.image && (
              <div className="image-container">
                <img src={item.image} alt={item.title} />
              </div>
            )}
            
            <div className="mt-3">
              <div className="mb-2">
                {item.tags && item.tags.map((tag, index) => (
                  <span key={index} className="tag">
                    {tag}
                    <button 
                      className="ml-1 text-red-400 hover:text-red-600"
                      onClick={() => onTagRemove(item.id, index)}
                    >
                      ×
                    </button>
                  </span>
                ))}
              </div>
              
              <form onSubmit={handleAddTag} className="flex gap-2">
                <input
                  type="text"
                  className="dnd-input py-1 text-sm"
                  placeholder="Add a tag..."
                  value={newTag}
                  onChange={(e) => setNewTag(e.target.value)}
                />
                <button 
                  type="submit"
                  className="btn-dnd rounded px-2 py-1 text-sm"
                >
                  Add
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * Campaign Item Form
     **********************/
    function CampaignItemForm({ item, onSave, onCancel }) {
      const [title, setTitle] = React.useState(item ? item.title : "");
      const [content, setContent] = React.useState(item ? item.content : "");
      const [type, setType] = React.useState(item ? item.type : "Lore");
      const [image, setImage] = React.useState(item ? item.image : null);
      const [imagePreview, setImagePreview] = React.useState(item ? item.image : null);
      
      const typeOptions = ["Lore", "NPC", "Location", "Event", "Item", "Shenanigan", "Note"];
      
      function handleSubmit(e) {
        e.preventDefault();
        if (!title.trim()) {
          alert("Title is required");
          return;
        }
        
        onSave({
          id: item ? item.id : Date.now(),
          title: title.trim(),
          content: content.trim(),
          type,
          image,
          tags: item ? item.tags || [] : [],
          created: item ? item.created : new Date().toISOString(),
          updated: new Date().toISOString()
        });
      }
      
      function handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            setImage(evt.target.result);
            setImagePreview(evt.target.result);
          };
          reader.readAsDataURL(file);
        }
      }
      
      return (
        <form onSubmit={handleSubmit} className="space-y-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
          <div>
            <label className="block text-amber-400 mb-1">Title</label>
            <input
              type="text"
              className="dnd-input"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Enter title..."
              required
            />
          </div>
          
          <div>
            <label className="block text-amber-400 mb-1">Type</label>
            <div className="select-container">
              <select 
                className="dnd-select" 
                value={type} 
                onChange={(e) => setType(e.target.value)}
              >
                {typeOptions.map((option) => (
                  <option key={option} value={option}>{option}</option>
                ))}
              </select>
              <div className="select-arrow">▼</div>
            </div>
          </div>
          
          <div>
            <label className="block text-amber-400 mb-1">Content</label>
            <div className="textarea-container">
              <textarea
                value={content}
                onChange={(e) => setContent(e.target.value)}
                placeholder="Enter content..."
                className="dnd-input"
              />
              <div className="textarea-controls">
                <span className="char-count">{content.length} characters</span>
              </div>
            </div>
          </div>
          
          <div>
            <label className="block text-amber-400 mb-1">Image (optional)</label>
            <input
              type="file"
              accept="image/*"
              onChange={handleImageUpload}
              className="block text-amber-200 text-sm mb-2"
            />
            {imagePreview && (
              <div className="mt-2 relative">
                <img src={imagePreview} alt="Preview" className="max-h-48 rounded" />
                <button
                  type="button"
                  className="btn-dnd rounded absolute top-1 right-1 px-2 py-1 text-xs"
                  onClick={() => {
                    setImage(null);
                    setImagePreview(null);
                  }}
                >
                  Remove
                </button>
              </div>
            )}
          </div>
          
          <div className="flex justify-end space-x-3 mt-4">
            <button 
              type="button" 
              className="bg-gray-700 text-white rounded px-4 py-2 hover:bg-gray-600"
              onClick={onCancel}
            >
              Cancel
            </button>
            <button 
              type="submit" 
              className="btn-dnd rounded px-4 py-2"
            >
              Save
            </button>
          </div>
        </form>
      );
    }

    /**********************
     * Campaign Items Section
     **********************/
    function CampaignItemsSection() {
      const [items, setItems] = React.useState(() => {
        const saved = localStorage.getItem("campaignItems");
        return saved ? JSON.parse(saved) : [];
      });
      
      const [editingItem, setEditingItem] = React.useState(null);
      const [isAdding, setIsAdding] = React.useState(false);
      const [filter, setFilter] = React.useState("All");
      const [searchQuery, setSearchQuery] = React.useState("");
      
      React.useEffect(() => {
        localStorage.setItem("campaignItems", JSON.stringify(items));
      }, [items]);
      
      function handleAddItem() {
        setIsAdding(true);
        setEditingItem(null);
      }
      
      function handleEditItem(item) {
        setEditingItem(item);
        setIsAdding(false);
      }
      
      function handleSaveItem(item) {
        if (editingItem) {
          setItems(items.map(i => i.id === item.id ? item : i));
        } else {
          setItems([...items, item]);
        }
        setEditingItem(null);
        setIsAdding(false);
      }
      
      function handleDeleteItem(id) {
        setItems(items.filter(i => i.id !== id));
      }
      
      function handleAddTag(itemId, tag) {
        setItems(items.map(item => {
          if (item.id === itemId) {
            const tags = item.tags || [];
            if (!tags.includes(tag)) {
              return { ...item, tags: [...tags, tag] };
            }
          }
          return item;
        }));
      }
      
      function handleRemoveTag(itemId, tagIndex) {
        setItems(items.map(item => {
          if (item.id === itemId && item.tags) {
            const newTags = [...item.tags];
            newTags.splice(tagIndex, 1);
            return { ...item, tags: newTags };
          }
          return item;
        }));
      }

      // Filter and search items
      const filteredItems = items.filter(item => {
        const matchesFilter = filter === "All" || item.type === filter;
        const matchesSearch = searchQuery === "" || 
          item.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          item.content.toLowerCase().includes(searchQuery.toLowerCase()) ||
          (item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase())));
        
        return matchesFilter && matchesSearch;
      });
      
      return (
        <div className="content-panel">
          <div className="panel-header">
            <h2 className="panel-title">Campaign Journal</h2>
            <button className="btn-dnd rounded" onClick={handleAddItem}>Add Entry</button>
          </div>

          <div className="mb-4 bg-gray-800 p-3 rounded-lg border border-amber-900">
            <h3 className="text-amber-400 font-bold mb-1">Campaign Journal Features:</h3>
            <ol className="list-decimal pl-5 text-sm text-amber-300">
              <li className="mb-1">Record campaign lore, NPCs, locations and important events</li>
              <li className="mb-1">Track shenanigans and memorable moments</li>
              <li className="mb-1">Add images to entries for visual reference</li>
              <li className="mb-1">Tag entries for easy searching and organization</li>
              <li className="mb-1">Filter by entry type or search by keywords</li>
              <li className="mb-1">Create an event timeline to track the story chronologically</li>
              <li className="mb-1">Export journal data for use in AI prompts</li>
            </ol>
          </div>
          
          <div className="search-bar">
            <input
              type="text"
              className="dnd-input search-input"
              placeholder="Search journal..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
            <button 
              className="btn-dnd rounded py-2 px-4"
              onClick={() => setSearchQuery("")}
              disabled={!searchQuery}
            >
              Clear
            </button>
          </div>
          
          <div className="filters">
            {["All", "Lore", "NPC", "Location", "Event", "Item", "Shenanigan", "Note"].map(type => (
              <button
                key={type}
                className={`filter-btn ${filter === type ? "active" : ""}`}
                onClick={() => setFilter(type)}
              >
                {type}
              </button>
            ))}
          </div>
          
          {isAdding || editingItem ? (
            <CampaignItemForm 
              item={editingItem}
              onSave={handleSaveItem}
              onCancel={() => {
                setEditingItem(null);
                setIsAdding(false);
              }}
            />
          ) : (
            <div className="space-y-2">
              {filteredItems.length > 0 ? (
                filteredItems.map(item => (
                  <CampaignItem
                    key={item.id}
                    item={item}
                    onEdit={handleEditItem}
                    onDelete
